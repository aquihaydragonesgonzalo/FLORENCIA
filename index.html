
<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Florencia 2026 | Guía PWA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Florencia 2026">
    <meta name="description" content="Guía personalizada para la escala en Florencia (desde Livorno) 2026">
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjvVYlm-4zLxbxXytfjaMND4HGRSzqyWMEewJl-tKAd8Qs28rFd411YMWOfAV2YJu-IqqOB3KaBEw_0rFxpoFHCLiAHn7ZtqoxNYG1bZVZ4U7Q4cuIV9V-XU8JiyyT6aigIB0UJLpeWu4fXhfcQ_6nbrXd84YPRd7dZ8q1STw-rLcfTdkCTa5oAoPuTPZ8/s320/Gemini_Generated_Image_l4457il4457il445.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        genova: { 
                          50: '#eff6ff', 
                          100: '#dbeafe', 
                          200: '#bfdbfe', 
                          300: '#93c5fd', 
                          400: '#60a5fa', 
                          500: '#3b82f6', 
                          600: '#2563eb', 
                          700: '#1d4ed8', 
                          800: '#1e40af', 
                          900: '#1e3a8a' 
                        },
                        superba: {
                          gold: '#D97706',
                          red: '#BE123C',
                          blue: '#1E3A8A'
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overscroll-behavior-y: none; background-color: #f8fafc; }
        body { font-family: 'Roboto Condensed', sans-serif; -webkit-tap-highlight-color: transparent; }
        #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-h-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-h-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-h-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .leaflet-bottom { bottom: 85px !important; }
        
        #initial-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1e3a8a; display: flex; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.4s ease-out;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?external=react",
    "recharts": "https://esm.sh/recharts@2.13.0?external=react",
    "leaflet": "https://esm.sh/leaflet@1.9.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="initial-loader">
        <div style="text-align: center; color: white;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 15px;"></div>
            <p style="font-weight: bold; letter-spacing: 1.5px; font-size: 11px; text-transform: uppercase; opacity: 0.8;">Iniciando Guía Florencia</p>
        </div>
    </div>

    <div id="root"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            CalendarClock, Map as MapIcon, Wallet, BookOpen, Anchor, 
            Headphones, X, Play, Square, Navigation, CheckCircle2, 
            Circle, MapPin, AlertTriangle, Clock, ExternalLink, AlertCircle,
            Volume2, Languages, PhoneCall, Thermometer, ArrowRight,
            Sun, Cloud, CloudRain, CloudLightning, Calendar, Footprints, Activity as ActivityIcon, Send,
            Wind, CalendarDays, TrendingDown, Info
        } from 'lucide-react';
        import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';

        // --- DATA & CONSTANTS ---
        
        const SHIP_DEPARTURE_TIME = "20:00";
        const SHIP_ONBOARD_TIME = "19:30";
        const DATE_OF_VISIT = "2026-04-15";

        const COORDS = {
            LIVORNO_PORT: { lat: 43.552781, lng: 10.301390 },
            LIVORNO_STATION: { lat: 43.554202, lng: 10.33564 },
            FIRENZE_SMN: { lat: 43.776539, lng: 11.248277 },
            DUOMO: { lat: 43.773127, lng: 11.255386 },
            PONTE_VECCHIO: { lat: 43.76795, lng: 11.253097 },
            PITTI: { lat: 43.765294, lng: 11.249918 }
        };

        const GPX_WAYPOINTS = [
            { name: "Estación Santa Maria Novella", lat: 43.776539, lng: 11.248277 },
            { name: "Capilla de los Medici", lat: 43.775039, lng: 11.253357 },
            { name: "Basílica de San Lorenzo", lat: 43.774947, lng: 11.253846 },
            { name: "Galería de la Academia", lat: 43.776901, lng: 11.258696 },
            { name: "Plaza del Duomo", lat: 43.773127, lng: 11.255386 },
            { name: "Santa Maria de las Flores", lat: 43.773127, lng: 11.256944 },
            { name: "Baptisterio de San Juan", lat: 43.773153, lng: 11.25505 },
            { name: "Piazza della Signoria", lat: 43.769713, lng: 11.255829 },
            { name: "Palazzo Vecchio", lat: 43.769278, lng: 11.255947 },
            { name: "Loggia dei Lanzi", lat: 43.769244, lng: 11.255556 },
            { name: "Puente Vecchio", lat: 43.76795, lng: 11.253097 },
            { name: "Palazzo Pitti", lat: 43.765294, lng: 11.249918 },
            { name: "Puesto de Souvenir", lat: 43.775168, lng: 11.249542 },
            { name: "Estación de Tren Livorno", lat: 43.554202, lng: 10.33564 },
            { name: "Punto Shuttle Livorno", lat: 43.551830, lng: 10.308314 }
        ];

        const FLORENCE_TRACK = [
            [43.776531, 11.249154], [43.776698, 11.249086], [43.776755, 11.249145], [43.776779, 11.249237],
            [43.776798, 11.249313], [43.776812, 11.249369], [43.776305, 11.249569], [43.775923, 11.24968],
            [43.775298, 11.249946], [43.775089, 11.250034], [43.775258, 11.250764], [43.775154, 11.250878],
            [43.774821, 11.25123], [43.774787, 11.252249], [43.774785, 11.252452], [43.774969, 11.252737],
            [43.775116, 11.25299], [43.775122, 11.253155], [43.775216, 11.253341], [43.775182, 11.25354],
            [43.775265, 11.253729], [43.77515, 11.254051], [43.775005, 11.254306], [43.77474, 11.254571],
            [43.774658, 11.254535], [43.774586, 11.254952], [43.775005, 11.255147], [43.774828, 11.255726],
            [43.774859, 11.255899], [43.775407, 11.256287], [43.775801, 11.256577], [43.776674, 11.257263],
            [43.776705, 11.257371], [43.776366, 11.258173], [43.776512, 11.258333], [43.776993, 11.258731],
            [43.774519, 11.256796], [43.774341, 11.256646], [43.773497, 11.256006], [43.773433, 11.255959],
            [43.773442, 11.255412], [43.773411, 11.255068], [43.773448, 11.254654], [43.773176, 11.254614],
            [43.773591, 11.256796], [43.773607, 11.257088], [43.773425, 11.257347], [43.773079, 11.25767],
            [43.772579, 11.257831], [43.772606, 11.25681], [43.772718, 11.255851], [43.772499, 11.255369],
            [43.772245, 11.255359], [43.771554, 11.255332], [43.770864, 11.255304], [43.770213, 11.255279],
            [43.769887, 11.255296], [43.769395, 11.255371], [43.769317, 11.255591], [43.769223, 11.255859],
            [43.769133, 11.255827], [43.768519, 11.25559], [43.767863, 11.255292], [43.767797, 11.255029],
            [43.76801, 11.254686], [43.768333, 11.253851], [43.768466, 11.253503], [43.767844, 11.253048],
            [43.767603, 11.252867], [43.767465, 11.252732], [43.767204, 11.252356], [43.767017, 11.251928],
            [43.766707, 11.251225], [43.766576, 11.250981], [43.766384, 11.25075], [43.766126, 11.250346],
            [43.766001, 11.25007], [43.765856, 11.249752], [43.765705, 11.249583], [43.765469, 11.249776],
            [43.766094, 11.249499], [43.766545, 11.248898], [43.766735, 11.248335], [43.767268, 11.248709],
            [43.767496, 11.248925], [43.768031, 11.249412], [43.768187, 11.249545], [43.768519, 11.249975],
            [43.768652, 11.250028], [43.769444, 11.250584], [43.769512, 11.25069], [43.769987, 11.251069],
            [43.770283, 11.251303], [43.77071, 11.251373], [43.771466, 11.251361], [43.771635, 11.250887],
            [43.771866, 11.2507], [43.772627, 11.250516], [43.773029, 11.250439], [43.773441, 11.250201],
            [43.773581, 11.250179], [43.774198, 11.249934], [43.77467, 11.249856], [43.774801, 11.249803],
            [43.775139, 11.249793], [43.775265, 11.249627], [43.77529, 11.249118], [43.775397, 11.248972],
            [43.775537, 11.248942], [43.775754, 11.249213], [43.776069, 11.249237], [43.776155, 11.248885]
        ];

        const INITIAL_ITINERARY = [
        {
        "id": "0",
        "title": "Llegada a Puerto Livorno",
        "startTime": "07:00",
        "endTime": "07:00",
        "locationName": "Puerto de Livorno",
        "coords": { "lat": 43.552781, "lng": 10.301390 },
        "description": "Llegada del crucero al puerto.",
        "keyDetails": "Hora oficial de atraque.",
        "priceEUR": 0,
        "type": "logistics",
        "completed": false,
        "notes": "CRITICAL"
        },
        {
        "id": "1",
        "title": "Desembarco y llegada al Shuttle",
        "startTime": "07:15",
        "endTime": "07:30",
        "locationName": "Puerto Industrial (Livorno)",
        "coords": { "lat": 43.552781, "lng": 10.301390 },
        "description": "Inicio del desembarco en el puerto industrial. Salida inmediata hacia el punto de transporte.",
        "keyDetails": "Dirigirse a la zona de autobuses/lanzaderas.",
        "priceEUR": 0,
        "type": "logistics",
        "completed": false,
        "notes": "CRITICAL"
        },
        {
        "id": "2",
        "title": "Trayecto en Shuttle MSC",
        "startTime": "07:30",
        "endTime": "07:45",
        "locationName": "Punto de Shuttle (Puerto)",
        "endLocationName": "Piazza Municipio",
        "coords": { "lat": 43.552781, "lng": 10.301390 },
        "endCoords": { "lat": 43.551830, "lng": 10.308314 },
        "description": "Del muelle a la Piazza del Municipio. Servicio de lanzadera que conecta el barco con el centro de la ciudad.",
        "keyDetails": "Traslado del barco al centro de Livorno.",
        "priceEUR": 7,
        "type": "transport",
        "completed": false,
        "notes": "BUS"
        },
        {
        "id": "3",
        "title": "Bus a la Estación",
        "startTime": "08:00",
        "endTime": "08:10",
        "locationName": "Piazza Municipio / Kiosco",
        "endLocationName": "Estación de Tren Livorno",
        "coords": { "lat": 43.55073, "lng": 10.30858 },
        "endCoords": { "lat": 43.554202, "lng": 10.33564 },
        "description": "Compra de billetes en Kiosco y bus a la estación. Trámite rápido para acceder al transporte público.",
        "keyDetails": "Comprar ticket en 'KIOSCO PARA COMPRAR TICKET AUTOBUS' antes de subir.",
        "priceEUR": 1.5,
        "type": "transport",
        "completed": false,
        "googleMapsUrl": "https://maps.app.goo.gl/8MQxJ5Ftbaz6sSWd9",
        "contingencyNote": "Si el bus tarda, valorar taxi."
        },
        {
        "id": "4",
        "title": "Tren Regional: Livorno -> Florencia",
        "startTime": "08:49",
        "endTime": "10:02",
        "locationName": "Estación de Tren Livorno",
        "endLocationName": "Estación Santa Maria Novella",
        "coords": { "lat": 43.554202, "lng": 10.33564 },
        "endCoords": { "lat": 43.776539, "lng": 11.248277 },
        "description": "Trayecto directo a la Estación Sta. Maria Novella. Viaje panorámico a través de la campiña toscana.",
        "keyDetails": "Tren directo a Firenze Santa Maria Novella.",
        "priceEUR": 12,
        "type": "transport",
        "completed": false,
        "googleMapsUrl": "https://maps.app.goo.gl/w1LYWJrugoicFRzZ8"
        },
        {
        "id": "5",
        "title": "Capilla Medici y Basílica San Lorenzo",
        "startTime": "10:15",
        "endTime": "10:30",
        "locationName": "Capilla de los Medici",
        "coords": { "lat": 43.775039, "lng": 11.253357 },
        "description": "Visita a la obra de Brunelleschi y Miguel Ángel. Mausoleo de la familia Medici y una de las iglesias más antiguas.",
        "keyDetails": "Integrado en el conjunto de San Lorenzo. La Capilla de los príncipes destaca.",
        "priceEUR": 0,
        "type": "sightseeing",
        "completed": false,
        "audioGuideText": "Integrado en el conjunto de la Basílica de San Lorenzo, en este edificio fueron enterrados los miembros de la familia Medici a partir del siglo XV. La Capilla de los príncipes, destinada a los grandes duques Medici, se construyó el siglo XVII."
        },
        {
        "id": "6",
        "title": "Galería de la Academia (El David)",
        "startTime": "10:40",
        "endTime": "11:50",
        "locationName": "Galería de la Academia",
        "coords": { "lat": 43.776901, "lng": 11.258696 },
        "description": "Hogar del David de Miguel Ángel. Museo que alberga la escultura más famosa del mundo.",
        "keyDetails": "REQUIERE RESERVA PREVIA ONLINE.",
        "contingencyNote": "COMPRAR PREVIAMENTE LA ENTRADA ONLINE.",
        "priceEUR": 24,
        "type": "sightseeing",
        "completed": false,
        "audioGuideText": "Uno de los museos más conocidos de Florencia, sobre todo porque en su interior se conserva el celebérrimo David de Miguel Ángel."
        },
        {
        "id": "7",
        "title": "Duomo y Baptisterio",
        "startTime": "12:00",
        "endTime": "12:15",
        "locationName": "Plaza del Duomo",
        "coords": { "lat": 43.773127, "lng": 11.255386 },
        "description": "Centro religioso de la ciudad. Complejo con la cúpula de Brunelleschi, el Campanile y las puertas del Baptisterio.",
        "keyDetails": "Observar la Puerta del Paraíso en el Baptisterio.",
        "priceEUR": 0,
        "type": "sightseeing",
        "completed": false,
        "audioGuideText": "Esta plaza es por derecho propio el centro religioso de Florencia. En ella está ubicada la catedral (Duomo), junto al campanile y el baptisterio. Destaca sobremanera su gran cúpula, sobresaliente en todas las panorámicas de la ciudad y el campanile de casi 85 metros de altura construido por Giotto."
        },
        {
        "id": "8",
        "title": "Almuerzo y Souvenirs",
        "startTime": "12:20",
        "endTime": "12:35",
        "locationName": "Zona Centro / Puesto Souvenir",
        "coords": { "lat": 43.775168, "lng": 11.249542 },
        "description": "Tiempo para comida y compras.",
        "keyDetails": "Breve parada gastronómica.",
        "priceEUR": 0,
        "type": "food",
        "completed": false
        },
        {
        "id": "9",
        "title": "Piazza della Signoria",
        "startTime": "12:35",
        "endTime": "12:45",
        "locationName": "Piazza della Signoria",
        "coords": { "lat": 43.769713, "lng": 11.255829 },
        "description": "Sede del poder civil y museo al aire libre.",
        "keyDetails": "Plaza principal con estatuas al aire libre.",
        "priceEUR": 0,
        "type": "sightseeing",
        "completed": false,
        "audioGuideText": "Sede del poder civil de Florencia por los edificios que en ella se encuentran: Palazzo Vecchio, Loggia dei Lanzi o della Signoria, Tribunal de las Mercancías, Palacio Uguccioni o el Palacio de las Aseguraciones Generales."
        },
        {
        "id": "10",
        "title": "Palazzo Vecchio",
        "startTime": "12:45",
        "endTime": "13:05",
        "locationName": "Palazzo Vecchio",
        "coords": { "lat": 43.769278, "lng": 11.255947 },
        "description": "Edificio que representa el poder civil, construido en época medieval.",
        "keyDetails": "Ayuntamiento histórico de Florencia.",
        "priceEUR": 0,
        "type": "sightseeing",
        "completed": false,
        "audioGuideText": "Este edificio ha representado históricamente el poder civil en Florencia. Construido en época medieval alberga actualmente un museo con obras de Bronzino, Giorgio Vasari o Miguel Ángel."
        },
        {
        "id": "11",
        "title": "Loggia dei Lanzi",
        "startTime": "13:05",
        "endTime": "13:20",
        "locationName": "Loggia dei Lanzi",
        "coords": { "lat": 43.769244, "lng": 11.255556 },
        "description": "Pórtico convertido por los Medici en museo al aire libre.",
        "keyDetails": "Galería de esculturas en la plaza.",
        "priceEUR": 0,
        "type": "sightseeing",
        "completed": false,
        "audioGuideText": "Construido entre el 1379 y 1381 este pórtico estaba destinado a acoger las asambleas o las distintas ceremonias celebradas en la Piazza della Signoria. Cuando perdió su razón de ser los Medici convirtieron esta Loggia en un museo al aire libre."
        },
        {
        "id": "12",
        "title": "Puente Vecchio",
        "startTime": "13:30",
        "endTime": "13:45",
        "locationName": "Puente Vecchio",
        "coords": { "lat": 43.76795, "lng": 11.253097 },
        "description": "Cruce del río Arno. El puente de piedra medieval más icónico, famoso por sus joyerías.",
        "keyDetails": "Puente medieval con joyerías sobre el Arno.",
        "priceEUR": 0,
        "type": "sightseeing",
        "completed": false,
        "audioGuideText": "Es uno de los monumentos más visitados de Florencia. Fue reconstruido por completo el año 1345 en piedra y destaca por la gran actividad comercial que se desarrolla sobre él."
        },
        {
        "id": "13",
        "title": "Palazzo Pitti (Exteriores)",
        "startTime": "14:00",
        "endTime": "14:25",
        "locationName": "Palazzo Pitti",
        "coords": { "lat": 43.765294, "lng": 11.249918 },
        "description": "Gran palacio renacentista al otro lado del puente. Antigua residencia de los Grandes Duques.",
        "keyDetails": "Visita exterior para admirar la inmensidad del palacio.",
        "priceEUR": 0,
        "type": "sightseeing",
        "completed": false,
        "audioGuideText": "Inmenso palacio renacentista. En su interior cohabitan diferentes museos, como la Galería de Arte Moderno, el Museo de la Plata, Galería de trajes, Museo de Carruajes… no obstante destaca entre todos ellos la Galería Palatina, con obras pictóricas de Rafael, Rubens o Tiziano."
        },
        {
        "id": "14",
        "title": "Regreso a la Estación SMN",
        "startTime": "14:25",
        "endTime": "15:00",
        "locationName": "Palazzo Pitti",
        "endLocationName": "Estación Santa Maria Novella",
        "coords": { "lat": 43.765294, "lng": 11.249918 },
        "endCoords": { "lat": 43.776539, "lng": 11.248277 },
        "description": "Caminata de retorno hacia la principal terminal ferroviaria.",
        "keyDetails": "Llegada con margen para el tren de vuelta.",
        "priceEUR": 0,
        "type": "transport",
        "completed": false
        },
        {
        "id": "15",
        "title": "Tren Regional: Florencia -> Livorno",
        "startTime": "15:26",
        "endTime": "16:48",
        "locationName": "Estación Santa Maria Novella",
        "endLocationName": "Estación de Tren Livorno",
        "coords": { "lat": 43.776539, "lng": 11.248277 },
        "endCoords": { "lat": 43.554202, "lng": 10.33564 },
        "description": "Trayecto de vuelta para descansar tras la intensa caminata.",
        "keyDetails": "Tiempo de relax antes de la logística final.",
        "priceEUR": 12,
        "type": "transport",
        "completed": false,
        "contingencyNote": "El próximo tren no sale hasta dentro de una hora.",
        "googleMapsUrl": "https://maps.app.goo.gl/xTqRT8a7fCtDDU6AA"
        },
        {
        "id": "16",
        "title": "Bus a Shuttle MSC",
        "startTime": "17:05",
        "endTime": "17:28",
        "locationName": "Estación de Tren Livorno",
        "endLocationName": "Piazza Municipio",
        "coords": { "lat": 43.554202, "lng": 10.33564 },
        "endCoords": { "lat": 43.551830, "lng": 10.308314 },
        "description": "Retorno al muelle de atraque. Tramo final de transporte.",
        "keyDetails": "Autobús urbano de vuelta al shuttle.",
        "priceEUR": 1.5,
        "type": "transport",
        "completed": false,
        "googleMapsUrl": "https://maps.app.goo.gl/w7pZnGYRejacxzUP7"
        },
        {
        "id": "17",
        "title": "Shuttle a Barco",
        "startTime": "17:35",
        "endTime": "17:55",
        "locationName": "Piazza Municipio",
        "endLocationName": "Barco (Puerto)",
        "coords": { "lat": 43.551830, "lng": 10.308314 },
        "endCoords": { "lat": 43.552781, "lng": 10.301390 },
        "description": "Último trayecto hacia el barco.",
        "keyDetails": "Último traslado hacia el crucero.",
        "priceEUR": 0,
        "type": "transport",
        "completed": false
        },
        {
        "id": "18",
        "title": "Llegada al Crucero (Límite)",
        "startTime": "19:30",
        "endTime": "19:30",
        "locationName": "Puerto de Livorno",
        "coords": { "lat": 43.552781, "lng": 10.301390 },
        "description": "Meta lograda con margen de seguridad.",
        "keyDetails": "Tiempo de seguridad recomendado antes del zarpe.",
        "priceEUR": 0,
        "type": "logistics",
        "completed": false,
        "notes": "CRITICAL"
        },
        {
        "id": "19",
        "title": "Salida del Barco",
        "startTime": "20:00",
        "endTime": "20:00",
        "locationName": "Puerto de Livorno",
        "coords": { "lat": 43.552781, "lng": 10.301390 },
        "description": "Hora oficial de zarpe del puerto.",
        "keyDetails": "Zarpe del crucero.",
        "priceEUR": 0,
        "type": "logistics",
        "completed": false
        }
        ];

        const PRONUNCIATIONS = [
            { word: 'Buongiorno', phonetic: "Bwon-jor-no", simplified: 'Bwon-yor-no', meaning: 'Buenos días' },
            { word: 'Grazie', phonetic: "Grat-zye", simplified: 'Grat-sie', meaning: 'Gracias' },
            { word: 'Prego', phonetic: "Pre-go", simplified: 'Pre-go', meaning: 'De nada' },
            { word: 'Per favore', phonetic: "Per fa-vo-re", simplified: 'Por favor', meaning: 'Por favor' },
            { word: 'Dov\'è il bagno?', phonetic: "Do-ve il ba-nyo", simplified: 'Dové il baño', meaning: '¿Dónde está el baño?' },
            { word: 'Il conto, per favore', phonetic: "Il kon-to", simplified: 'La cuenta', meaning: 'La cuenta, por favor' }
        ];

        // --- UTILS ---
        
        const formatMinutes = (mins) => {
          const h = Math.floor(mins / 60);
          const m = mins % 60;
          if (h > 0 && m > 0) return `${h}h ${m}min`;
          if (h > 0) return `${h}h`;
          return `${m}min`;
        };

        const calculateDuration = (startStr, endStr) => {
          const [startH, startM] = startStr.split(':').map(Number);
          const [endH, endM] = endStr.split(':').map(Number);
          let diffMins = (endH * 60 + endM) - (startH * 60 + startM);
          if (diffMins < 0) diffMins += 24 * 60; 
          const hours = Math.floor(diffMins / 60);
          const minutes = diffMins % 60;
          if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
          if (hours > 0) return `${hours}h`;
          return `${minutes} min`;
        };

        const calculateTimeProgress = (startTime, endTime) => {
          const now = new Date();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          const [startH, startM] = startTime.split(':').map(Number);
          const startMinutes = startH * 60 + startM;
          const [endH, endM] = endTime.split(':').map(Number);
          const endMinutes = endH * 60 + endM;
          if (currentMinutes < startMinutes) return 0;
          if (currentMinutes >= endMinutes) return 100;
          return Math.min(100, Math.max(0, ((currentMinutes - startMinutes) / (endMinutes - startMinutes)) * 100));
        };

        // --- COMPONENTS ---

        const Timeline = ({ itinerary, onToggleComplete, onLocate, userLocation, onOpenAudioGuide }) => {
          const [, setTick] = useState(0);
          useEffect(() => { const t = setInterval(() => setTick(n => n + 1), 60000); return () => clearInterval(t); }, []);

          const calculateGap = (endStrPrev, startStrNext) => {
            const [endH, endM] = endStrPrev.split(':').map(Number);
            const [startH, startM] = startStrNext.split(':').map(Number);
            let diffMins = (startH * 60 + startM) - (endH * 60 + endM);
            return diffMins > 0 ? diffMins : 0;
          };

          const getStatusColor = (act) => {
            if (act.completed) return 'border-emerald-500 bg-emerald-50 bg-opacity-30';
            if (act.notes === 'CRITICAL') return 'border-rose-600 bg-rose-50';
            return 'border-blue-50 bg-white';
          };

          return (
            <div className="pb-24 px-4 pt-4 max-w-lg mx-auto">
              <div className="flex justify-between items-end mb-6">
                <h2 className="text-2xl font-bold text-blue-900 uppercase tracking-tight">Escala Livorno/Florencia</h2>
                <span className="text-[10px] font-black text-blue-400 uppercase tracking-widest bg-blue-50 px-2 py-1 rounded-md border border-blue-100">En Vivo</span>
              </div>
              
              <div className="relative border-l-2 border-blue-100 ml-3 space-y-8">
                {itinerary.map((act, idx) => {
                  const prevAct = idx > 0 ? itinerary[idx - 1] : null;
                  const gap = prevAct ? calculateGap(prevAct.endTime, act.startTime) : 0;
                  const isCritical = act.notes === 'CRITICAL';
                  const duration = calculateDuration(act.startTime, act.endTime);
                  const actProgress = calculateTimeProgress(act.startTime, act.endTime);
                  const gapProgress = prevAct ? calculateTimeProgress(prevAct.endTime, act.startTime) : 0;
                  
                  return (
                    <React.Fragment key={act.id}>
                      {gap > 0 && prevAct && (
                        <div className="relative ml-0 my-8">
                            <div className="absolute left-[-2px] top-[-20px] bottom-[-20px] border-l-2 border-dashed border-blue-200"></div>
                            <div className="ml-6 flex items-center">
                                <div className="bg-white/80 backdrop-blur-sm px-4 py-3 rounded-2xl border border-blue-50 flex flex-col shadow-sm w-full max-w-[240px]">
                                    <div className="flex items-center mb-2">
                                        <div className="bg-blue-100 p-1.5 rounded-full mr-3 border border-blue-200">
                                            <Clock size={12} className="text-blue-600" />
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-[9px] font-black text-blue-400 uppercase tracking-widest leading-none mb-1">Traslado</span>
                                            <span className="text-[10px] font-bold text-blue-600 uppercase">{formatMinutes(gap)} — {gap > 30 ? 'Paseo Libre' : 'Caminata'}</span>
                                        </div>
                                    </div>
                                    <div className="w-full h-1 bg-blue-50 rounded-full overflow-hidden">
                                        <div className="h-full bg-blue-300 transition-all duration-1000" style={{ width: `${gapProgress}%` }}></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                      )}

                      <div className="mb-8 ml-6 relative">
                        <div className={`absolute -left-[31px] top-0 rounded-full bg-white border-2 cursor-pointer transition-all z-10 ${act.completed ? 'border-emerald-500 text-emerald-500 shadow-sm' : 'border-blue-700 text-blue-700 shadow-sm'}`} onClick={() => onToggleComplete(act.id)}>
                            {act.completed ? <CheckCircle2 size={24} /> : <Circle size={24} />}
                        </div>

                        <div className={`rounded-2xl border shadow-sm transition-all overflow-hidden ${getStatusColor(act)} ${act.completed ? 'opacity-70' : 'shadow-md'}`}>
                            <div className="w-full h-1.5 bg-blue-50 overflow-hidden">
                                <div className={`h-full transition-all duration-1000 ${actProgress === 100 ? 'bg-slate-300' : 'bg-blue-800'}`} style={{ width: `${actProgress}%` }}></div>
                            </div>

                            <div className="p-5">
                                <div className="flex justify-between items-start mb-2">
                                <div>
                                    <div className="flex items-center space-x-2 mb-2">
                                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-800 tracking-tighter uppercase">{act.startTime} - {act.endTime}</span>
                                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-medium bg-slate-100 text-slate-600 border border-slate-200">{duration}</span>
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-800 leading-tight">{act.title}</h3>
                                </div>
                                {isCritical && <AlertTriangle className="text-rose-600 animate-pulse" size={20} />}
                                </div>

                                <div className="mb-3 text-sm text-slate-600 flex items-center">
                                    <MapPin size={14} className="mr-0.5 text-blue-700"/> 
                                    <span className="font-medium">{act.locationName}</span>
                                </div>

                                <p className="text-sm text-slate-600 mb-4 leading-relaxed whitespace-pre-line">{act.description}</p>
                                
                                <div className="bg-blue-50/50 p-3 rounded-xl text-sm text-blue-950 italic border-l-4 border-amber-500 mb-4">"{act.keyDetails}"</div>

                                <div className="flex flex-wrap items-center gap-2 mt-3 pt-4 border-t border-slate-50">
                                    <button onClick={() => onLocate(act.coords, act.endCoords)} className="flex items-center text-[10px] font-bold text-blue-800 bg-blue-50 px-3 py-2 rounded-xl border border-blue-100 hover:bg-blue-100 shadow-sm transition-colors">
                                        <Navigation size={12} className="mr-1.5" /> UBICACIÓN
                                    </button>
                                    
                                    {act.audioGuideText && (
                                      <button onClick={() => onOpenAudioGuide(act)} className="flex items-center text-[10px] font-bold text-amber-700 bg-amber-50 px-3 py-2 rounded-xl border border-amber-100 shadow-sm active:bg-amber-100"><Headphones size={12} className="mr-1.5" /> AUDIOGUÍA</button>
                                    )}

                                    <div className="ml-auto">
                                        <button onClick={() => onToggleComplete(act.id)} className={`px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all ${act.completed ? 'bg-emerald-100 text-emerald-700 border border-emerald-200' : 'bg-blue-900 text-white shadow-md active:scale-95'}`}>
                                        {act.completed ? 'Hecho' : 'Completar'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                      </div>
                    </React.Fragment>
                  );
                })}
              </div>
            </div>
          );
        };

        const Budget = ({ itinerary }) => {
            const COLORS = ['#1e3a8a', '#be123c', '#d97706', '#64748b'];
            const paidActivities = useMemo(() => itinerary.filter(a => a.priceEUR > 0), [itinerary]);
            const total = useMemo(() => paidActivities.reduce((acc, curr) => acc + curr.priceEUR, 0), [paidActivities]);
            const chartData = useMemo(() => paidActivities.map(act => ({ name: act.title, value: act.priceEUR })), [paidActivities]);

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto no-scrollbar">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold text-blue-900 flex items-center uppercase tracking-tight">
                    <Wallet className="mr-2" /> Gastos
                    </h2>
                </div>

                <div className="bg-gradient-to-br from-blue-800 to-blue-950 rounded-[2rem] p-6 text-white shadow-xl mb-8 border-2 border-white/10 relative overflow-hidden">
                    <div className="absolute top-[-20px] right-[-20px] w-32 h-32 bg-amber-400/20 rounded-full blur-2xl"></div>
                    <p className="text-blue-100 text-xs mb-1 uppercase tracking-widest font-black opacity-80">Presupuesto Escala</p>
                    <div className="text-4xl font-black">€{total}</div>
                    <p className="text-[10px] text-blue-100 mt-4 flex items-center font-bold uppercase tracking-tighter opacity-70">
                    <Info size={14} className="mr-1 text-amber-400"/> Incluye transporte a Florencia y entradas clave.
                    </p>
                </div>

                {paidActivities.length > 0 ? (
                    <>
                    <div className="bg-white rounded-3xl shadow-sm border border-blue-50 mb-8 overflow-hidden">
                        <h3 className="px-5 py-4 border-b border-blue-50 font-black text-xs text-slate-800 uppercase tracking-widest bg-slate-50/50">Desglose Florencia</h3>
                        {paidActivities.map((act, index) => (
                        <div key={act.id} className="flex justify-between items-center p-5 border-b border-slate-50 last:border-0">
                            <div className="flex items-center">
                            <div className="w-2.5 h-2.5 rounded-full mr-3" style={{ backgroundColor: COLORS[index % COLORS.length] }}></div>
                            <div>
                                <p className="text-sm font-bold text-slate-800">{act.title}</p>
                                <p className="text-[10px] text-slate-400 uppercase font-black tracking-tighter">{act.type}</p>
                            </div>
                            </div>
                            <div className="font-black text-blue-900">€{act.priceEUR}</div>
                        </div>
                        ))}
                    </div>

                    <div className="h-64 w-full mb-8 bg-white rounded-3xl border border-blue-50 shadow-sm p-4">
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                            <Pie data={chartData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={8} dataKey="value">
                                {chartData.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} stroke="none" />))}
                            </Pie>
                            <Tooltip contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)', fontFamily: 'inherit', fontWeight: 'bold' }} />
                            </PieChart>
                        </ResponsiveContainer>
                    </div>
                    </>
                ) : (
                    <div className="p-12 text-center bg-blue-50 rounded-[2.5rem] border-2 border-dashed border-blue-200 mb-8">
                    <Wallet className="mx-auto text-blue-200 mb-4" size={32} />
                    <p className="text-blue-400 font-bold uppercase tracking-widest text-xs">Sin gastos previstos</p>
                    </div>
                )}

                <div className="bg-amber-50 border border-amber-100 rounded-3xl p-5 flex items-start shadow-sm mb-12">
                    <TrendingDown className="text-amber-600 mt-1 mr-4 flex-shrink-0" size={20} />
                    <div>
                    <h4 className="font-black text-amber-800 text-xs uppercase tracking-widest">Consejo Ahorro</h4>
                    <p className="text-xs text-amber-700 mt-1 font-medium leading-relaxed">
                        El tren regional es mucho más económico que las excursiones del barco. Recuerda validar el billete antes de subir.
                    </p>
                    </div>
                </div>
                </div>
            );
        };

        const Guide = ({ userLocation }) => {
            const [playing, setPlaying] = useState(null);
            const [weather, setWeather] = useState(null);
            const [loadingWeather, setLoadingWeather] = useState(true);

            useEffect(() => {
                const fetchWeather = async () => {
                try {
                    const response = await fetch(
                    'https://api.open-meteo.com/v1/forecast?latitude=43.77&longitude=11.25&hourly=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe%2FRome'
                    );
                    const data = await response.json();
                    setWeather({
                    hourly: { time: data.hourly.time, temperature: data.hourly.temperature_2m, code: data.hourly.weathercode },
                    daily: { time: data.daily.time, weathercode: data.daily.weathercode, temperature_2m_max: data.daily.temperature_2m_max, temperature_2m_min: data.daily.temperature_2m_min }
                    });
                } catch (error) { console.error("Clima error:", error); } finally { setLoadingWeather(false); }
                };
                fetchWeather();
            }, []);

            const getWeatherIcon = (code, size = 20) => {
                if (code <= 1) return <Sun size={size} className="text-amber-500" />;
                if (code <= 3) return <Cloud size={size} className="text-slate-400" />;
                if (code <= 67) return <CloudRain size={size} className="text-blue-500" />;
                if (code <= 99) return <CloudLightning size={size} className="text-purple-500" />;
                return <Wind size={size} className="text-slate-400" />;
            };

            const playSimulatedAudio = (word) => {
                if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'it-IT';
                utterance.rate = 0.85;
                setPlaying(word);
                utterance.onend = () => setPlaying(null);
                window.speechSynthesis.speak(utterance);
                }
            };

            const handleSOS = () => {
                const message = userLocation ? `¡SOS! Necesito ayuda en Florencia. Mi ubicación actual es: https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}` : `¡SOS! Necesito ayuda en Florencia. No puedo obtener mi ubicación GPS.`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            };

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return new Intl.DateTimeFormat('es-ES', { weekday: 'short', day: 'numeric' }).format(date);
            };

            const visitSummary = {
                totalWindow: "12h 30min",
                sightseeingTime: "4h 10min",
                logisticsTime: "5h 20min",
                estimatedDistance: "5.5 km",
                stepsApprox: "~7.500",
                poiCount: 19,
                accessibility: "Transporte público + Caminata"
            };

            return (
                <div className="pb-32 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto no-scrollbar">
                <h2 className="text-2xl font-bold text-blue-900 mb-6 uppercase tracking-tight">Guía Florencia</h2>

                <div className="mb-8 bg-white rounded-[2rem] border border-blue-50 shadow-md p-6 overflow-hidden relative">
                    <div className="flex items-center gap-2 mb-4">
                    <ActivityIcon size={18} className="text-blue-700" />
                    <h3 className="text-xs font-black text-slate-800 uppercase tracking-widest">Resumen de la Visita</h3>
                    </div>
                    <div className="grid grid-cols-2 gap-y-5 gap-x-4">
                    <div className="flex flex-col"><span className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter mb-1">Escala Total</span><div className="flex items-center gap-1.5"><Clock size={14} className="text-blue-600" /><span className="text-sm font-black text-blue-950">{visitSummary.totalWindow}</span></div></div>
                    <div className="flex flex-col"><span className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter mb-1">Turismo Activo</span><div className="flex items-center gap-1.5"><Sun size={14} className="text-amber-500" /><span className="text-sm font-black text-blue-950">{visitSummary.sightseeingTime}</span></div></div>
                    <div className="flex flex-col"><span className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter mb-1">Distancia a pie</span><div className="flex items-center gap-1.5"><ActivityIcon size={14} className="text-emerald-600" /><span className="text-sm font-black text-blue-950">{visitSummary.estimatedDistance}</span></div></div>
                    <div className="flex flex-col"><span className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter mb-1">Pasos aprox.</span><div className="flex items-center gap-1.5"><Footprints size={14} className="text-slate-600" /><span className="text-sm font-black text-blue-950">{visitSummary.stepsApprox}</span></div></div>
                    </div>
                </div>

                <div className="mb-8 bg-rose-700 rounded-[2rem] p-6 shadow-xl text-white relative overflow-hidden border-2 border-white/10">
                    <div className="absolute top-[-20px] right-[-20px] w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                    <div className="relative z-10">
                    <div className="flex items-center mb-3"><PhoneCall size={24} className="text-white animate-pulse mr-3" /><h3 className="font-black text-lg uppercase tracking-widest">ASISTENCIA SOS</h3></div>
                    <p className="text-xs text-rose-50 mb-6 leading-relaxed font-medium">Si te desorientas en el centro, envía tu ubicación GPS exacta al contacto de emergencia por WhatsApp.</p>
                    <button onClick={handleSOS} className="w-full py-4 bg-white text-rose-800 font-black rounded-2xl flex items-center justify-center gap-2 shadow-lg uppercase tracking-widest text-sm active:scale-95 transition-transform"><Send size={18} /> Enviar Localización</button>
                    </div>
                </div>

                <div className="mb-8">
                    <h3 className="text-sm font-black text-slate-800 mb-4 flex items-center uppercase tracking-widest px-1"><Thermometer size={18} className="mr-2 text-blue-900"/> Tiempo en Florencia</h3>
                    {loadingWeather ? (<div className="h-24 bg-white rounded-3xl animate-pulse border border-blue-50"></div>) : (
                    <>
                        <div className="bg-white p-2 pb-5 rounded-[2.5rem] border border-blue-50 shadow-xl overflow-hidden mb-4">
                        <h4 className="text-[10px] font-black text-blue-300 uppercase tracking-widest text-center mt-2 mb-2">Hoy</h4>
                        <div className="flex overflow-x-auto gap-3 px-6 py-2 no-scrollbar">
                            {weather?.hourly.time.map((time, i) => {
                            const hour = new Date(time).getHours();
                            if (hour >= 8 && hour <= 20) return (
                                <div key={time} className="flex flex-col items-center justify-between min-w-[70px] p-3 bg-blue-50/50 rounded-3xl border border-blue-100">
                                <span className="text-[10px] font-black text-blue-400 mb-2">{hour}:00</span>
                                <div className="p-2 bg-white rounded-2xl mb-2 shadow-sm">{getWeatherIcon(weather.hourly.code[i], 24)}</div>
                                <span className="text-sm font-black text-blue-900">{Math.round(weather.hourly.temperature[i])}°</span>
                                </div>
                            );
                            return null;
                            })}
                        </div>
                        </div>
                        <div className="bg-white rounded-[2rem] border border-blue-50 shadow-lg p-5">
                        <div className="flex items-center gap-2 mb-4 px-1"><CalendarDays size={16} className="text-blue-500" /><span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Próximos 5 días</span></div>
                        <div className="space-y-1">
                            {weather?.daily.time.slice(0, 5).map((day, i) => (
                            <div key={day} className="flex items-center justify-between p-3 hover:bg-slate-50 rounded-xl transition-colors">
                                <span className="w-16 text-xs font-bold text-slate-600 capitalize">{formatDate(day)}</span>
                                <div className="flex items-center gap-3">{getWeatherIcon(weather.daily.weathercode[i], 18)}</div>
                                <div className="flex items-center gap-3 w-20 justify-end"><span className="text-xs font-bold text-slate-800">{Math.round(weather.daily.temperature_2m_max[i])}°</span><span className="text-xs font-medium text-slate-400">{Math.round(weather.daily.temperature_2m_min[i])}°</span></div>
                            </div>
                            ))}
                        </div>
                        </div>
                    </>
                    )}
                </div>

                <h3 className="text-sm font-black text-slate-800 mb-4 flex items-center uppercase tracking-widest px-1"><Languages size={18} className="mr-2 text-blue-900"/> Italiano Básico</h3>
                <div className="bg-white rounded-3xl shadow-md border border-blue-50 overflow-hidden mb-8">
                    {PRONUNCIATIONS.map((item) => (
                    <div key={item.word} className="p-5 flex justify-between items-center border-b border-slate-50 last:border-0 hover:bg-blue-50/30 transition-colors group">
                        <div><div className="flex items-center gap-3"><p className="font-black text-blue-950 text-lg">{item.word}</p><button onClick={() => playSimulatedAudio(item.word)} className={`p-2 rounded-full transition-all ${playing === item.word ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-400 group-hover:bg-blue-50'}`}><Volume2 size={16} /></button></div><p className="text-xs text-slate-500 italic">"{item.simplified}"</p></div>
                        <p className="text-[10px] font-black text-blue-500 bg-blue-50 px-3 py-1 rounded-full uppercase tracking-tighter border border-blue-100">{item.meaning}</p>
                    </div>
                    ))}
                </div>
                </div>
            );
        };

        const MapComponent = ({ activities, userLocation, focusedLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);

            useEffect(() => {
                if (!mapContainerRef.current || mapInstanceRef.current) return;
                const map = L.map(mapContainerRef.current, { zoomControl: false }).setView([43.7731, 11.2553], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 18, attribution: '&copy; OpenStreetMap' }).addTo(map);
                mapInstanceRef.current = map;
                return () => { map.remove(); mapInstanceRef.current = null; };
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                layersRef.current.forEach(layer => layer.remove());
                layersRef.current = [];

                const defaultIcon = L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                });

                activities.forEach(act => {
                const marker = L.marker([act.coords.lat, act.coords.lng], { icon: defaultIcon }).addTo(map);
                marker.bindPopup(`<div style="padding: 10px; font-family: 'Roboto Condensed', sans-serif;"><h3 style="margin: 0; font-weight: bold; color: #1e3a8a;">${act.title}</h3><p style="margin: 4px 0 0 0; font-size: 11px; color: #64748b;">${act.locationName}</p></div>`);
                layersRef.current.push(marker);
                });

                GPX_WAYPOINTS.forEach(wpt => {
                const circleMarker = L.circleMarker([wpt.lat, wpt.lng], { radius: 6, fillColor: "#BE123C", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map);
                circleMarker.bindPopup(`<div style="font-size: 12px; font-weight: bold; color: #BE123C;">${wpt.name}</div>`);
                layersRef.current.push(circleMarker);
                });

                if (FLORENCE_TRACK.length > 0) {
                const trackLine = L.polyline(FLORENCE_TRACK, { color: '#1e3a8a', weight: 4, opacity: 0.7, dashArray: '8, 12' }).addTo(map);
                layersRef.current.push(trackLine);
                }

                if (userLocation) {
                const userIcon = L.divIcon({ className: 'user-marker', html: '<div style="background-color: #3b82f6; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(59,130,246,0.5);"></div>', iconSize: [18, 18] });
                const marker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
                layersRef.current.push(marker);
                }
            }, [activities, userLocation]);

            useEffect(() => { if (mapInstanceRef.current && focusedLocation) mapInstanceRef.current.flyTo([focusedLocation.lat, focusedLocation.lng], 16); }, [focusedLocation]);
            return <div ref={mapContainerRef} className="w-full h-full z-0" />;
        };

        const App = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [activeTab, setActiveTab] = useState('timeline');
            const [userLocation, setUserLocation] = useState(null);
            const [mapFocus, setMapFocus] = useState(null);
            const [countdown, setCountdown] = useState('00h 00m 00s');
            const [audioGuideActivity, setAudioGuideActivity] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('genova_guide_v1_storage');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        const merged = INITIAL_ITINERARY.map(initItem => {
                            const savedItem = parsed.find(p => p.id === initItem.id);
                            return savedItem ? { ...initItem, completed: savedItem.completed } : initItem;
                        });
                        setItinerary(merged);
                    } catch(e) {}
                }
            }, []);

            const handleToggleComplete = (id) => {
                const newItinerary = itinerary.map(act => act.id === id ? { ...act, completed: !act.completed } : act);
                setItinerary(newItinerary);
                localStorage.setItem('genova_guide_v1_storage', JSON.stringify(newItinerary));
            };

            useEffect(() => {
                if ('geolocation' in navigator) {
                    const watchId = navigator.geolocation.watchPosition(pos => setUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude }), err => console.log(err), { enableHighAccuracy: true });
                    return () => navigator.geolocation.clearWatch(watchId);
                }
            }, []);

            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    const [hours, minutes] = SHIP_ONBOARD_TIME.split(':').map(Number);
                    const target = new Date();
                    target.setHours(hours, minutes, 0, 0);
                    const diff = target.getTime() - now.getTime();
                    if (diff <= 0) setCountdown("¡A BORDO!");
                    else {
                        const h = Math.floor(diff / (1000 * 60 * 60));
                        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((diff % (1000 * 60)) / 1000);
                        setCountdown(`${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`);
                    }
                }, 1000);
                setTimeout(() => { const l = document.getElementById('initial-loader'); if(l) { l.style.opacity = '0'; setTimeout(() => l.remove(), 500); }}, 800);
                return () => clearInterval(timer);
            }, []);

            const handleLocate = (coords) => { setMapFocus(coords); setActiveTab('map'); };
            const handlePlayAudio = () => {
                if (!audioGuideActivity?.audioGuideText) return;
                if (isPlaying) { window.speechSynthesis.cancel(); setIsPlaying(false); }
                else {
                    const utterance = new SpeechSynthesisUtterance(audioGuideActivity.audioGuideText);
                    utterance.lang = 'es-ES';
                    utterance.rate = 0.95;
                    utterance.onend = () => setIsPlaying(false);
                    window.speechSynthesis.speak(utterance);
                    setIsPlaying(true);
                }
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden">
                <header className="bg-blue-950 text-white p-4 shadow-xl z-20 flex justify-between items-center shrink-0">
                    <div className="flex items-center">
                    <Anchor className="mr-3 text-amber-500" size={24} />
                    <div><h1 className="font-black text-[10px] uppercase tracking-[0.2em] text-blue-300">Escala Florencia</h1><p className="text-[12px] font-bold text-white/90 leading-tight">15 Abril 2026</p></div>
                    </div>
                    <div className="flex flex-col items-end"><span className="text-[8px] font-black uppercase text-amber-400 tracking-widest mb-0.5">Límite Embarque</span><div className="text-lg font-black font-mono text-white leading-none tracking-tighter">{countdown}</div></div>
                </header>

                <main className="flex-1 overflow-hidden relative">
                    {activeTab === 'timeline' && (<div className="h-full overflow-y-auto no-scrollbar"><Timeline itinerary={itinerary} onToggleComplete={handleToggleComplete} onLocate={handleLocate} userLocation={userLocation} onOpenAudioGuide={(act) => setAudioGuideActivity(act)} /></div>)}
                    {activeTab === 'map' && (<MapComponent activities={itinerary} userLocation={userLocation} focusedLocation={mapFocus} />)}
                    {activeTab === 'budget' && <Budget itinerary={itinerary} />}
                    {activeTab === 'guide' && <Guide userLocation={userLocation} />}

                    {audioGuideActivity && (
                        <div className="absolute inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-blue-950/40 backdrop-blur-sm animate-in fade-in duration-200">
                        <div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-in slide-in-from-bottom-8 duration-300">
                            <div className="p-8">
                            <div className="flex justify-between items-start mb-6">
                                <div className="bg-blue-100 p-3 rounded-2xl border border-blue-200"><Headphones size={24} className="text-blue-700" /></div>
                                <button onClick={() => { window.speechSynthesis.cancel(); setIsPlaying(false); setAudioGuideActivity(null); }} className="text-slate-300 hover:text-slate-600 transition-colors"><X size={28} /></button>
                            </div>
                            <h3 className="text-xs font-black text-blue-400 uppercase tracking-[0.2em] mb-2">Audioguía</h3>
                            <h4 className="text-xl font-black text-slate-800 mb-6 leading-tight">{audioGuideActivity.title}</h4>
                            <div className="max-h-[300px] overflow-y-auto pr-2 custom-h-scrollbar mb-8"><p className="text-slate-600 leading-relaxed font-medium italic">{audioGuideActivity.audioGuideText}</p></div>
                            <div className="flex gap-4"><button onClick={handlePlayAudio} className={`flex-1 flex items-center justify-center gap-3 py-4 rounded-3xl font-black uppercase tracking-widest text-sm transition-all shadow-lg active:scale-95 ${isPlaying ? 'bg-rose-600 text-white shadow-rose-200' : 'bg-blue-900 text-white shadow-blue-200'}`}>{isPlaying ? <Square size={18} fill="white" /> : <Play size={18} fill="white" />}{isPlaying ? 'Detener' : 'Escuchar'}</button></div>
                            </div>
                        </div>
                        </div>
                    )}
                </main>

                <nav className="bg-white/95 backdrop-blur-md border-t border-slate-100 z-30 shrink-0 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                    <div className="flex justify-around items-center h-20 px-2 pb-safe">
                    {[{ id: 'timeline', icon: CalendarClock, label: 'Itinerario' }, { id: 'map', icon: MapIcon, label: 'Mapa' }, { id: 'budget', icon: Wallet, label: 'Gastos' }, { id: 'guide', icon: BookOpen, label: 'Guía' }].map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-full justify-center transition-all ${activeTab === tab.id ? 'text-blue-900' : 'text-slate-400'}`}>
                        <div className={`p-2 rounded-xl mb-1 ${activeTab === tab.id ? 'bg-blue-50 shadow-sm' : ''}`}><tab.icon size={22} /></div><span className="text-[9px] font-black uppercase tracking-widest">{tab.label}</span>
                        </button>
                    ))}
                    </div>
                </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
